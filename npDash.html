<!DOCTYPE html>
<!-- Initial prototpe of the genome visualisation tool -->
<html lang="en">
    <head>
        <meta charset="UTF-8"> 
        <!--<script type="text/javascript" src="d3.min.js"></script>  Local copy-->
        <script src="https://d3js.org/d3.v4.min.js"></script> <!-- Direct link -->
        <style>
            .pairs {
               stroke: #F00;
               stroke-width: 8px;
            }
            .pairs text {
               font: 7px sans-serif;
               stroke: #000;
               stroke-width: 0px;
            }
            .links {
               stroke: #444;
               stroke-width: 1px;
            }
            .node {
              fill: #ccc;
              stroke: #000;
              stroke-width: 1.5px;
            }
          
            .node.fixed {
                fill: #f00;
            }
            .controls {
                font: 7px sans-serif;
                background-color: lightslategray;
                padding: 10px;
            }
            .visual {
                display: block;
                margin-left: auto;
                margin-right: auto;
                border: 1px solid darkgrey;
            }
        </style>
    </head>
<body>
    <div id="visual">
    <script>
        /**
         *  Date: 07-MAR-2017
         *  
         */
        
        /* Variable to set the visualisation to reload data */
        var dynamic = 1;

        /* Set the SVG canvas size */
        var width = 800,
            height = 600;

        /* Specify the SVG canvas */
        var svg = d3.select('body').append('svg')
            .attr('width', width)
            .attr('height', height)
            .attr('class','visual');

        /* Specify the forces that will be used by the visualisation */
        var visual = d3.forceSimulation()
            //.nodes(nodes)
            .force("pairs", d3.forceLink().id(function(d) { return d.id; }))
            .force("link", d3.forceLink().id(function(d) { return d.id; }))
            .force("charge", d3.forceManyBody())
            .force("center", d3.forceCenter(width / 2, height / 2))
            .on('tick', ticked); // Render the visualisation
            //.force("collision", d3.forceCollide(2));
        
        visual.stop();

        /* Selections */
        var node = svg.selectAll('circle');
        var pairs = svg.selectAll('.pairs');
        var links = svg.selectAll('.links');

        /* Read the JSON file located in the same directory */
        d3.json("assembly.json", function(error, d) {
            if (error) throw error;

            /* Update the data for visualisation */
            update(d);

            visual.alpha(1).restart(); // Re-energise/restart the simulation

        }); // End d3.json read
        
        /* Loop the simulation */
        if (dynamic == 1 ) {
            setInterval(function() {
                visual.stop();
                ///* Read the JSON file located in the same directory */
                d3.json("assembly.json", function(error, d) {
                
                    if (error) throw error;          
                
                    update(d);  // This should really be an update function
                    visual.restart().alpha(1); // Re-energise the simulation

                }); // End d3.json read
            }, 30000); // Refresh once every 30 seconds.
        }

        /* update function */
        function update(d) {

            // Update the nodes
            // This selection will return update()
            node = node.data(d.nodes);
            
            // Remove nodes with no data associated
            node.exit().remove();
            
            // Build the elements for the new nodes
            var nodeup = node.enter().append('g')
                .attr('class', 'node')
                .attr("id", function(d) {
                    return d.id
                });
            
            nodeup.append('circle');
            node = nodeup.merge(node);
            visual.nodes(d.nodes);
            //console.log(d.nodes);

            /**
             * Select and join contig nodes to create the graph edge (DNA sequence).
             * Data (contigData) is bound to the HTML? elements 'pairs'. Drawing 
             * will commence at the start of simulation.
             */
            pairs = pairs.data(d.contigData);

            pairs.exit().remove();

            /* Need to group the elements to meet HTML spec for text labels */
            var pairup = pairs.enter().append('g')
                .attr('class', 'pairs');

            pairup.append('line');
            pairup.append('text')
                .text(function(d) {return d.source});

            pairs = pairup.merge(pairs);
            
            /**
             * Scaling the lengths to ensure that the contigs will fit on in the 
             * SVG canvas.
             */
            var lengthScale = d3.scaleLinear()
                .domain([0, d3.max(d.contigData, function(d) {
                    return d.length;
                })])
                .range([0,256]); // Range 0 - 250 px

            // Draw the contig
            visual.force('pairs')
                .links(d.contigData)
                .distance(function(d,i) {
                    //console.log(d);
                    return lengthScale(d.length);
                })
                .iterations(10); // Enforce the distance (adds runtime cost)


            /* Select and join the contig adjacencies */
            links = links.data(d.contigLinks);

            links.exit().remove();

            var linkup = links.enter()
                .append('line')
                .attr('class','links');
                //.exit().remove();

            links = linkup.merge(links);

            //console.log(d.contigLinks);
            
            // Draw the contig adjacencies
            visual.force('link')
                .links(d.contigLinks)//;
                .distance(10)   // Also reduce the distance between adj edges
              .iterations(10);    // Maybe add as a user setting

            /**
             * Specify forces between nodes to prevent them from stacking on each
             * other.
             * Negative strength = repulsion.
             * Positive strength = attraction.
             * manyBody.distanceMin and manyBody.distanceMax used to localise
             * the forces between nearby nodes instead of over the whole
             * visualisation
             */
            visual.force("charge")
                .strength(-180)
                .distanceMin(25)
                .distanceMax(80); // Selected based on trial and error
        }

        function ticked() {
            /**
             * Start the real-time visualisation
             */

                node.select('circle')
                    .attr('cx', function(d) { return d.x; })    // Node x-coordinate
                    .attr('cy', function(d) { return d.y; });   // Node y-coordinate
                    //.attr('r', 1)                  // Node radius (Not required)

                // Transform the svg group associated with the nodes
                node.attr("transform", function(d) {
                    return "translate(" + d.x + "," + d.y + ")";
                    });
                
                // Transform the svg group associated with the sequence
                pairs.attr("transform", function(d) {
                    return "translate(" + d.source.x + "," + d.source.y + ")";
                    });
                
                /* Since the pairs group has been transformed their associated 
                 * coordinates are now relative. We need to add x & y-axis
                 * offsets for correct display.
                 */
                pairs.select('line')
                    .attr('x1', function(d) { return d.source.x - d.source.x; })
                    .attr('y1', function(d) { return d.source.y - d.source.y; })
                    .attr('x2', function(d) { return d.target.x - d.source.x; })
                    .attr('y2', function(d) { return d.target.y - d.source.y; });

                links.attr('x1', function(d) { return d.source.x; })
                    .attr('y1', function(d) { return d.source.y; })
                    .attr('x2', function(d) { return d.target.x; })
                    .attr('y2', function(d) { return d.target.y; });
                    
           // }); // End force.on anon function
        }

        </script>
        </div> <!--id=npDash-->
        <div class="controls">
            <h1>Controls will go here?</h1>
        </div><!--id=control>
    </body>
</html>